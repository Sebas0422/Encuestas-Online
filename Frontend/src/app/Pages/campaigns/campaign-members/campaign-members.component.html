<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <button class="btn btn-outline-secondary mb-3" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Volver
      </button>
      <h2 class="mb-0">
        <i class="bi bi-people-fill text-primary me-2"></i>
        Miembros de la Campaña
      </h2>
      <p class="text-muted" *ngIf="campaign">{{ campaign.name }}</p>
    </div>
    <button class="btn btn-primary" (click)="openAddModal()" *ngIf="canManageMembers()">
      <i class="bi bi-person-plus-fill me-2"></i>
      Agregar Miembro
    </button>
  </div>

  <!-- Mensajes de error/éxito -->
  <div class="alert alert-success alert-dismissible fade show" *ngIf="successMessage">
    <i class="bi bi-check-circle-fill me-2"></i>
    {{ successMessage }}
    <button type="button" class="btn-close" (click)="successMessage = ''"></button>
  </div>

  <div class="alert alert-danger alert-dismissible fade show" *ngIf="errorMessage && !showAddModal && !showEditModal">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
  </div>

  <!-- Loading Spinner -->
  <div class="text-center py-5" *ngIf="loading && members.length === 0">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3 text-muted">Cargando miembros...</p>
  </div>

  <!-- Lista de Miembros -->
  <div class="members-list" *ngIf="!loading || members.length > 0">
    <div class="card member-card" *ngFor="let member of members">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="member-info">
            <div class="d-flex align-items-center mb-2">
              <div class="member-avatar me-3">
                <i class="bi bi-person-circle"></i>
              </div>
              <div>
                <h5 class="mb-0">{{ getMemberDisplayName(member) }}</h5>
                <p class="text-muted mb-0 small" *ngIf="member.userEmail">{{ member.userEmail }}</p>
                <p class="text-muted mb-0 small" *ngIf="!member.userEmail">ID: {{ member.userId }}</p>
              </div>
            </div>
          </div>

          <div class="member-actions d-flex align-items-center gap-2">
            <span class="badge" [ngClass]="getRoleBadgeClass(member.role)">
              <i [class]="getRoleIcon(member.role) + ' me-1'"></i>
              {{ getRoleLabel(member.role) }}
            </span>

            <button 
              class="btn btn-sm btn-outline-primary"
              (click)="openEditModal(member)"
              *ngIf="canEditMember(member)"
              title="Cambiar rol">
              <i class="bi bi-pencil"></i>
            </button>

            <button 
              class="btn btn-sm btn-outline-danger"
              (click)="removeMember(member)"
              *ngIf="canEditMember(member)"
              title="Eliminar miembro">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>

        <div class="member-meta mt-2">
          <small class="text-muted">
            <i class="bi bi-calendar-plus me-1"></i>
            Agregado: {{ member.createdAt | date: 'dd/MM/yyyy HH:mm' }}
          </small>
        </div>
      </div>
    </div>

    <!-- Estado vacío -->
    <div class="text-center py-5" *ngIf="members.length === 0 && !loading">
      <i class="bi bi-people display-1 text-muted"></i>
      <p class="mt-3 text-muted">No hay miembros en esta campaña</p>
      <button class="btn btn-primary" (click)="openAddModal()">
        <i class="bi bi-person-plus-fill me-2"></i>
        Agregar primer miembro
      </button>
    </div>
  </div>
</div>

<!-- Modal: Agregar Miembro -->
<div class="modal fade show d-block" *ngIf="showAddModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-person-plus-fill me-2"></i>
          Agregar Miembro
        </h5>
        <button type="button" class="btn-close" (click)="closeAddModal()"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger" *ngIf="errorMessage">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage }}
        </div>

        <!-- Búsqueda de usuario -->
        <div class="mb-3">
          <label for="searchEmail" class="form-label">Buscar usuarios por email o nombre</label>
          <div class="input-group">
            <input 
              type="text" 
              class="form-control" 
              id="searchEmail"
              [(ngModel)]="searchEmail"
              (keyup.enter)="searchUsersByEmail()"
              placeholder="Escribe el email o nombre del usuario...">
            <button 
              class="btn btn-outline-primary" 
              type="button" 
              (click)="searchUsersByEmail()"
              [disabled]="searchLoading">
              <span class="spinner-border spinner-border-sm me-1" *ngIf="searchLoading"></span>
              <i class="bi bi-search" *ngIf="!searchLoading"></i>
              Buscar
            </button>
          </div>
          <small class="text-muted">Ingresa al menos 3 caracteres. Puedes seleccionar múltiples usuarios.</small>
        </div>

        <!-- Resultados de búsqueda -->
        <div class="search-results mb-3" *ngIf="searchResults.length > 0">
          <label class="form-label">Resultados de búsqueda (haz click para seleccionar):</label>
          <div class="list-group">
            <button 
              type="button"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              [class.active]="isUserSelected(user)"
              *ngFor="let user of searchResults"
              (click)="selectUser(user)">
              <div>
                <strong>{{ user.fullName }}</strong>
                <br>
                <small class="text-muted">{{ user.email }}</small>
              </div>
              <i class="bi bi-check-circle-fill" *ngIf="isUserSelected(user)"></i>
              <i class="bi bi-circle" *ngIf="!isUserSelected(user)"></i>
            </button>
          </div>
        </div>

        <!-- Usuarios seleccionados -->
        <div class="selected-users mb-3" *ngIf="selectedUsers.length > 0">
          <label class="form-label">Usuarios seleccionados ({{ selectedUsers.length }}):</label>
          <div class="d-flex flex-wrap gap-2">
            <div class="badge bg-primary d-flex align-items-center gap-2 p-2" *ngFor="let user of selectedUsers">
              <span>{{ user.fullName }}</span>
              <button 
                type="button" 
                class="btn-close btn-close-white btn-sm"
                (click)="removeSelectedUser(user)"
                style="font-size: 0.7rem;"></button>
            </div>
          </div>
        </div>

        <!-- Selección de rol -->
        <div class="mb-3" *ngIf="selectedUsers.length > 0">
          <label for="memberRole" class="form-label">Rol para todos los usuarios seleccionados *</label>
          <select class="form-select" id="memberRole" [(ngModel)]="newMemberRole">
            <option [value]="MemberRole.READER">
              <i class="bi bi-eye-fill"></i> Lector (solo lectura)
            </option>
            <option [value]="MemberRole.CREATOR">
              <i class="bi bi-pencil-fill"></i> Creador (puede modificar)
            </option>
            <option [value]="MemberRole.ADMIN">
              <i class="bi bi-star-fill"></i> Administrador (control total)
            </option>
          </select>
        </div>

        <div class="role-descriptions" *ngIf="selectedUsers.length > 0">
          <small class="text-muted">
            <strong>Roles:</strong><br>
            <i class="bi bi-eye-fill text-info"></i> <strong>Lector:</strong> Solo puede ver la campaña y formularios<br>
            <i class="bi bi-pencil-fill text-warning"></i> <strong>Creador:</strong> Puede crear y modificar formularios<br>
            <i class="bi bi-star-fill text-danger"></i> <strong>Administrador:</strong> Control total sobre la campaña
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddModal()">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="addMember()"
          [disabled]="loading || selectedUsers.length === 0">
          <span class="spinner-border spinner-border-sm me-2" *ngIf="loading"></span>
          <i class="bi bi-plus-circle me-2" *ngIf="!loading"></i>
          Agregar {{ selectedUsers.length > 1 ? selectedUsers.length + ' miembros' : 'miembro' }}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showAddModal"></div>

<!-- Modal: Editar Rol -->
<div class="modal fade show d-block" *ngIf="showEditModal && editingMember" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil-fill me-2"></i>
          Cambiar Rol
        </h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger" *ngIf="errorMessage">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage }}
        </div>

        <p>
          <strong>Miembro:</strong> {{ editingMember.userFullName }}<br>
          <small class="text-muted">{{ editingMember.userEmail }}</small>
        </p>

        <div class="mb-3">
          <label for="editRoleSelect" class="form-label">Nuevo Rol</label>
          <select class="form-select" id="editRoleSelect" [(ngModel)]="editRole">
            <option [value]="MemberRole.READER">Lector</option>
            <option [value]="MemberRole.CREATOR">Creador</option>
            <option [value]="MemberRole.ADMIN">Administrador</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="updateRole()"
          [disabled]="loading">
          <span class="spinner-border spinner-border-sm me-2" *ngIf="loading"></span>
          <i class="bi bi-check-circle me-2" *ngIf="!loading"></i>
          Actualizar
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showEditModal"></div>
